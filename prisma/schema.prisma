// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Shop {
  id                          String   @id @default(uuid())
  shopId                      String   @unique
  name                        String?
  status                      String   @default("active")
  tiktokShopCipher            String?
  tiktokWarehouseId           String?
  tiktokDefaultCategoryId     String?
  tiktokBrandId               String?
  tiktokBrandName             String?
  tiktokCurrency              String?
  tiktokSaveMode              String?
  tiktokPackageWeight         Float?
  tiktokPackageWeightUnit     String?
  tiktokPackageLength         Float?
  tiktokPackageWidth          Float?
  tiktokPackageHeight         Float?
  tiktokPackageDimensionUnit  String?
  tiktokMinimumOrderQuantity  Int?
  tiktokListingPlatforms      Json?
  vtexAccount                 String?
  vtexEnvironment             String?
  vtexDomain                  String?
  vtexAppKey                  String?
  vtexAppToken                String?
  vtexAffiliateId             String?
  vtexSalesChannel            String?
  vtexWarehouseId             String?
  vtexWebhookToken            String?
  vtexMarketplaceServicesEndpoint String?
  vtexPaymentSystemId         String?
  vtexPaymentSystemName       String?
  vtexPaymentGroup            String?
  vtexPaymentMerchant         String?
  vtexPricingDomain           String?
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  @@index([vtexAccount])
  @@index([vtexAffiliateId])
  @@index([vtexWebhookToken])
}

model TiktokAuth {
  id              String   @id @default(uuid())
  shopId          String   @unique
  accessToken     String
  accessExpiresAt DateTime
  refreshToken    String
  scopes          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ProductMap {
  id           String   @id @default(uuid())
  vtexSkuId    String
  shopId       String
  ttsProductId String?
  ttsSkuId     String?
  ttsCategoryId String?
  status       String
  lastError    String?
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())

  @@unique([shopId, vtexSkuId])
  @@index([shopId])
}

model OrderMap {
  id          String   @id @default(uuid())
  shopId      String
  ttsOrderId  String
  vtexOrderId String?
  status      String
  lastError   String?
  labelUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([shopId, ttsOrderId])
  @@index([shopId])
}

model Idempotency {
  id          String   @id @default(uuid())
  key         String   @unique
  processedAt DateTime @default(now())
  payloadHash String
}

model TiktokCategory {
  id          String    @id
  parentId    String?
  parent      TiktokCategory? @relation("TiktokCategoryHierarchy", fields: [parentId], references: [id])
  children    TiktokCategory[] @relation("TiktokCategoryHierarchy")
  name        String
  fullPath    String?
  level       Int?
  attributes  Json?
  version     String?
  isLeaf      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([parentId])
  @@index([version])
}

model VtexCategoryMap {
  id               String   @id @default(uuid())
  vtexCategoryId   String
  shopId           String?
  tiktokCategoryId String
  confidence       Float?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([shopId, vtexCategoryId])
  @@index([shopId])
  @@index([tiktokCategoryId])
}
